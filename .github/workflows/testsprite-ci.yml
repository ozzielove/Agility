name: TestSprite CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18.x'
  XCODE_VERSION: '15.0'

jobs:
  # ==========================================
  # Lint & Format Check
  # ==========================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linters
        run: |
          npm run lint || true

  # ==========================================
  # Unit Tests
  # ==========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests

  # ==========================================
  # Generate PRD from Codebase
  # ==========================================
  generate-prd:
    name: Generate PRD
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Generate PRD from codebase
        run: npm run generate-prd

      - name: Upload PRD artifact
        uses: actions/upload-artifact@v3
        with:
          name: generated-prd
          path: docs/GENERATED_PRD.md
          retention-days: 30

  # ==========================================
  # Generate Test Suites
  # ==========================================
  generate-tests:
    name: Generate Test Suites
    runs-on: ubuntu-latest
    needs: generate-prd
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Download PRD
        uses: actions/download-artifact@v3
        with:
          name: generated-prd
          path: docs/

      - name: Generate test plans
        run: npm run generate-test-plans || true

      - name: Generate test suites
        run: npm run generate-test-suites || true

      - name: Upload test suites
        uses: actions/upload-artifact@v3
        with:
          name: test-suites
          path: testsprite/test-suites/
          retention-days: 30

  # ==========================================
  # iOS Build & Tests
  # ==========================================
  ios-tests:
    name: iOS Tests
    runs-on: macos-13
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Install dependencies
        run: |
          cd ios
          pod install || true

      - name: Build iOS app
        run: |
          cd ios
          xcodebuild build \
            -workspace Agility.xcworkspace \
            -scheme Agility \
            -destination 'platform=iOS Simulator,name=iPhone 14 Pro,OS=17.0' \
            | xcpretty || true

      - name: Run iOS tests
        run: |
          cd ios
          xcodebuild test \
            -workspace Agility.xcworkspace \
            -scheme Agility \
            -destination 'platform=iOS Simulator,name=iPhone 14 Pro,OS=17.0' \
            | xcpretty || true

  # ==========================================
  # Backend API Tests
  # ==========================================
  backend-tests:
    name: Backend API Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Run backend tests
        run: |
          cd backend
          npm test

  # ==========================================
  # TestSprite Cloud Execution
  # ==========================================
  testsprite-cloud:
    name: TestSprite Cloud Tests
    runs-on: ubuntu-latest
    needs: [generate-tests, ios-tests, backend-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Download test suites
        uses: actions/download-artifact@v3
        with:
          name: test-suites
          path: testsprite/test-suites/

      - name: Run TestSprite cloud tests
        env:
          TESTSPRITE_API_KEY: ${{ secrets.TESTSPRITE_API_KEY }}
        run: npm run test:cloud || true

      - name: Upload test reports
        uses: actions/upload-artifact@v3
        with:
          name: testsprite-reports
          path: testsprite/reports/
          retention-days: 90

  # ==========================================
  # Financial Flow Validation
  # ==========================================
  financial-flows:
    name: Financial Flow Tests
    runs-on: ubuntu-latest
    needs: testsprite-cloud
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run financial flow validation
        env:
          TESTSPRITE_API_KEY: ${{ secrets.TESTSPRITE_API_KEY }}
        run: npm run test:financial-flows || true

  # ==========================================
  # Deploy to Staging
  # ==========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [testsprite-cloud, financial-flows]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.agility.app
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to staging
        run: echo "Deploying to staging..."
        # Add your deployment script here

  # ==========================================
  # Deploy to Production
  # ==========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [testsprite-cloud, financial-flows]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://agility.app
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to production
        run: echo "Deploying to production..."
        # Add your deployment script here
